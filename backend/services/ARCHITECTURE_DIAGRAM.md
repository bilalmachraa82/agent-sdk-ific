# EVF Agent Orchestrator - Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         EVF Portugal 2030 Platform                       â”‚
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                       FastAPI Application                           â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚  â”‚ POST /processâ”‚  â”‚ GET /status  â”‚  â”‚ POST /cancel â”‚             â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                  â”‚                  â”‚                       â”‚
â”‚            â–¼                  â–¼                  â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    EVF ORCHESTRATOR                             â”‚   â”‚
â”‚  â”‚                   (State Machine Controller)                     â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚  [State: PENDING â†’ IN_PROGRESS â†’ COMPLETED/FAILED]             â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚              Processing Pipeline (Sequential)              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Step 1 (15%)    Step 2 (20%)    Step 3 (20%)             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Input   â”‚â”€â”€â”€â†’â”‚Financial â”‚â”€â”€â”€â†’â”‚Complianceâ”‚             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Agent   â”‚    â”‚  Agent   â”‚    â”‚  Agent   â”‚             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚       â”‚               â”‚                â”‚                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚       â–¼               â–¼                â–¼                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Parse SAF-T    Calculate VALF   Validate PT2030         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Normalize      Calculate TRF     Check Rules            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Extract Data   30+ Ratios        Generate Warnings      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Step 4 (25%)    Step 5 (10%)                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚Narrative â”‚â”€â”€â”€â†’â”‚  Audit   â”‚                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â”‚  Agent   â”‚    â”‚  Agent   â”‚                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚       â”‚               â”‚                                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚       â–¼               â–¼                                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Generate Text   Log Everything                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  (Claude API)    Track Costs                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Format Report   Create Audit                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                            â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚              Support Systems                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Error Handling (retry, rollback, recovery)            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Progress Tracking (real-time, ETA calculation)        â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Cost Tracking (tokens, EUR, limits)                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Cancellation (graceful cleanup)                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Audit Trail (every operation logged)                  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                  â”‚                  â”‚                       â”‚
â”‚            â–¼                  â–¼                  â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   PostgreSQL    â”‚  â”‚   Redis     â”‚  â”‚   Qdrant Cloud  â”‚            â”‚
â”‚  â”‚  (Multi-tenant) â”‚  â”‚   Cache     â”‚  â”‚   Vector Store  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Agent Flow Detail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Agent Execution Flow                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INPUT AGENT (15% weight)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Parse SAF-T XML                   â”‚
â”‚ 2. Extract financial statements      â”‚
â”‚ 3. Normalize data structures         â”‚
â”‚ 4. Validate completeness             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ {parsed_data}
             â–¼
FINANCIAL AGENT (20% weight)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Convert to FinancialInput         â”‚
â”‚ 2. Calculate VALF (NPV at 4%)        â”‚  âœ… DETERMINISTIC
â”‚ 3. Calculate TRF (IRR)               â”‚  âœ… NO AI/LLM
â”‚ 4. Calculate 30+ ratios              â”‚  âœ… REPRODUCIBLE
â”‚ 5. Store FinancialModel in DB        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ {valf, trf, ratios}
             â–¼
COMPLIANCE AGENT (20% weight)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Check VALF < 0                    â”‚  âœ… RULE-BASED
â”‚ 2. Check TRF < 4%                    â”‚  âœ… DETERMINISTIC
â”‚ 3. Validate funding limits           â”‚  âœ… NO AI/LLM
â”‚ 4. Generate compliance report        â”‚
â”‚ 5. Update project compliance_status  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ {compliant, errors, warnings}
             â–¼
NARRATIVE AGENT (25% weight)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Build context from all data       â”‚  ğŸ¤– USES CLAUDE
â”‚ 2. Generate executive summary        â”‚  ğŸ¤– LLM-POWERED
â”‚ 3. Format financial analysis         â”‚  ğŸ¤– CREATIVE TEXT
â”‚ 4. Create compliance narrative       â”‚
â”‚ 5. Track tokens and costs            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚ {narrative, tokens, cost}
             â–¼
AUDIT AGENT (10% weight)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Log all agent executions          â”‚
â”‚ 2. Calculate total costs             â”‚
â”‚ 3. Create audit trail entries        â”‚
â”‚ 4. Generate processing summary       â”‚
â”‚ 5. Update project metadata           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## State Machine

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Processing State Machine                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

DRAFT
  â”‚
  â”‚ orchestrator.process_evf()
  â–¼
INITIALIZING (0%)
  â”‚
  â”‚ Load project, validate, set context
  â–¼
PARSING_INPUT (5-20%)
  â”‚
  â”‚ InputAgent execution
  â–¼
CALCULATING_FINANCIALS (20-40%)
  â”‚
  â”‚ FinancialAgent execution
  â–¼
VALIDATING_COMPLIANCE (40-60%)
  â”‚
  â”‚ ComplianceAgent execution
  â–¼
GENERATING_NARRATIVE (60-85%)
  â”‚
  â”‚ NarrativeAgent execution (if enabled)
  â–¼
AUDITING_RESULTS (85-95%)
  â”‚
  â”‚ AuditAgent execution
  â–¼
FINALIZING (95-100%)
  â”‚
  â”‚ Update project, cleanup
  â–¼
COMPLETED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚
ERROR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ FAILED
                        â”‚
CANCELLED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Error Handling Strategy                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Agent Execution
      â”‚
      â–¼
  Try Execute
      â”‚
      â”œâ”€â–º Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                                      â”‚
      â””â”€â–º Error                              â”‚
           â”‚                                 â”‚
           â”œâ”€â–º Attempt 1 Failed              â”‚
           â”‚   Wait 5s                       â”‚
           â”‚   Retry â”€â–º Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
           â”‚          â””â”€â–º Error              â”‚
           â”‚                â”‚                â”‚
           â”œâ”€â–º Attempt 2 Failed              â”‚
           â”‚   Wait 5s                       â”‚
           â”‚   Retry â”€â–º Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
           â”‚          â””â”€â–º Error              â”‚
           â”‚                â”‚                â”‚
           â””â”€â–º Attempt 3 Failed              â”‚
               Wait 5s                       â”‚
               Retry â”€â–º Success â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  â”‚
                      â””â”€â–º Final Error        â”‚
                           â”‚                 â”‚
                           â–¼                 â”‚
                      Log Error              â”‚
                      Update Status          â”‚
                      Create Audit Log       â”‚
                      Rollback DB            â”‚
                      Return AgentResult     â”‚
                           â”‚                 â”‚
                           â””â”€â”€â”€â”€â”€â”€â”€â”€â–º  Continue or Fail
                                            â”‚
                                            â–¼
                                      Check Critical
                                            â”‚
                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                           â–¼                                 â–¼
                      Critical Agent                   Non-Critical Agent
                      (Financial, Input)               (Narrative)
                           â”‚                                 â”‚
                           â–¼                                 â–¼
                      FAIL PROCESSING                  CONTINUE (warning)
                      Set status=FAILED                Set status=COMPLETED
```

## Database Updates

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Database Update Flow                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

START PROCESSING
â”‚
â”œâ”€â–º evf_projects
â”‚   â””â”€â–º UPDATE status = 'processing'
â”‚   â””â”€â–º UPDATE processing_start_time = NOW()
â”‚
â”œâ”€â–º audit_log
â”‚   â””â”€â–º INSERT action = 'orchestrator_start'
â”‚
FINANCIAL AGENT COMPLETE
â”‚
â”œâ”€â–º financial_models
â”‚   â””â”€â–º INSERT (valf, trf, ratios, calculations, ...)
â”‚
â”œâ”€â–º evf_projects
â”‚   â””â”€â–º UPDATE valf = calculated_valf
â”‚   â””â”€â–º UPDATE trf = calculated_trf
â”‚
â”œâ”€â–º audit_log
â”‚   â””â”€â–º INSERT action = 'financial_calculation'
â”‚
COMPLIANCE AGENT COMPLETE
â”‚
â”œâ”€â–º evf_projects
â”‚   â””â”€â–º UPDATE compliance_status = 'compliant'
â”‚   â””â”€â–º UPDATE compliance_errors = []
â”‚
â”œâ”€â–º audit_log
â”‚   â””â”€â–º INSERT action = 'compliance_validation'
â”‚
NARRATIVE AGENT COMPLETE
â”‚
â”œâ”€â–º audit_log
â”‚   â””â”€â–º INSERT action = 'narrative_generation'
â”‚   â””â”€â–º UPDATE tokens_used = 500
â”‚   â””â”€â–º UPDATE cost_euros = 0.15
â”‚
PROCESSING COMPLETE
â”‚
â”œâ”€â–º evf_projects
â”‚   â””â”€â–º UPDATE status = 'review'
â”‚   â””â”€â–º UPDATE processing_end_time = NOW()
â”‚   â””â”€â–º UPDATE processing_duration_seconds = duration
â”‚   â””â”€â–º UPDATE metadata = {processing_summary}
â”‚
â””â”€â–º audit_log
    â””â”€â–º INSERT action = 'orchestrator_complete'
    â””â”€â–º UPDATE metadata = {full_summary}
```

## Multi-Tenant Isolation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Multi-Tenant Data Isolation                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Request with JWT
      â”‚
      â”‚ Extract tenant_id from token
      â–¼
  Set Session Context
      â”‚
      â”‚ SET app.current_tenant = 'tenant_uuid'
      â–¼
  PostgreSQL RLS
      â”‚
      â”œâ”€â–º SELECT * FROM evf_projects
      â”‚   WHERE tenant_id = current_setting('app.current_tenant')::uuid
      â”‚
      â”œâ”€â–º SELECT * FROM financial_models
      â”‚   WHERE tenant_id = current_setting('app.current_tenant')::uuid
      â”‚
      â””â”€â–º SELECT * FROM audit_log
          WHERE tenant_id = current_setting('app.current_tenant')::uuid

Every query automatically filtered by tenant_id
No cross-tenant data leakage possible
```

## Cost Tracking

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Cost Tracking Flow                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Start Processing
  total_tokens = 0
  total_cost = â‚¬0.00
      â”‚
      â–¼
InputAgent
  tokens = 0 (no AI)
  cost = â‚¬0.00
      â”‚
      â–¼
FinancialAgent
  tokens = 0 (deterministic)
  cost = â‚¬0.00
      â”‚
      â–¼
ComplianceAgent
  tokens = 0 (rule-based)
  cost = â‚¬0.00
      â”‚
      â–¼
NarrativeAgent
  â”œâ”€â–º Call Claude API
  â”‚   Input: 1,000 tokens
  â”‚   Output: 500 tokens
  â”‚   Total: 1,500 tokens
  â”‚
  â”œâ”€â–º Calculate Cost
  â”‚   Input: 1,000 Ã— â‚¬0.003/1K = â‚¬0.003
  â”‚   Output: 500 Ã— â‚¬0.015/1K = â‚¬0.0075
  â”‚   Total: â‚¬0.0105
  â”‚
  â””â”€â–º Update Totals
      total_tokens += 1,500
      total_cost += â‚¬0.0105
      â”‚
      â–¼
Check Cost Limit
  if total_cost > limit (â‚¬5.00):
      log_warning()
      # Continue anyway (just warn)
      â”‚
      â–¼
AuditAgent
  Store total_tokens and total_cost
  in audit_log and evf_result
```

## Progress Calculation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Progress Percentage Calculation                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step Weights (Total = 100%):
  INITIALIZING            â†’   5%
  PARSING_INPUT           â†’  15%
  CALCULATING_FINANCIALS  â†’  20%
  VALIDATING_COMPLIANCE   â†’  20%
  GENERATING_NARRATIVE    â†’  25%
  AUDITING_RESULTS        â†’  10%
  FINALIZING              â†’   5%

Progress Calculation:
  progress = sum(weights of completed steps)

Example Timeline:
  00:00 - Start             â†’   0%  (INITIALIZING)
  00:10 - Input complete    â†’  20%  (15% + 5%)
  00:30 - Financial done    â†’  40%  (20% + 20%)
  01:00 - Compliance done   â†’  60%  (20% + 40%)
  02:30 - Narrative done    â†’  85%  (25% + 60%)
  02:45 - Audit done        â†’  95%  (10% + 85%)
  02:50 - Finalized         â†’ 100%  (5% + 95%)

ETA Calculation:
  elapsed = now - start_time
  if progress > 0:
      total_estimated = elapsed Ã— (100 / progress)
      remaining = total_estimated - elapsed
      eta = now + remaining
```

---

**Document Version**: 1.0.0
**Last Updated**: 2025-01-07
**Status**: Production Architecture
